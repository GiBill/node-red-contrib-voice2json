<!--
  Copyright 2020, Bart Butenaers & Johannes Kropf
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<script type="text/javascript">
    function getSelectedSlotRow() {
        var slotContainer = $("#node-input-slots-container");
        
        // Get all the 'selectedField' elements (i.e. the first column), which have css visibility set to 'visible'
        var selectedFields = slotContainer.find('.node-input-slot-selected').filter(function() {
            return $(this).css('visibility').toLowerCase() === 'visible';
        })
        
        if (selectedFields.length > 0) {
            // Return the slot row (as jQuery object) of the visible selectedField
            return selectedFields.eq(0).parent();
        }
        
        // No selected slot row
        return null;    
    }
    
    function setAceEditorReadOnly(aceEditor, readOnly) {
        aceEditor.setReadOnly(readOnly);
        
        // Make sure the ACE editor looks really disabled when required.
        if (readOnly) {
            aceEditor.container.style.opacity=0.5;
            aceEditor.renderer.setStyle("disabled", true);
        }
        else {
            //aceEditor.container.style.pointerEvents="auto";
            aceEditor.container.style.opacity=1;
            aceEditor.renderer.setStyle("disabled", false);   
        }
    }

    RED.nodes.registerType('voice2json-config',{
        category: 'config',
        color: '#ff758d',
        defaults: {
            profilePath: {value:"", required:true},
            name: {value:""},
            sentences: {value:null},
            slots: {value:[], validate: function (v) {
                // Map the list of javascript objects to a file name array
                var fileNameArray = v.map(function(item){ return item.fileName });
                
                if (fileNameArray.indexOf("") >= 0) {
                    // Not valid if empty file names
                    return false;
                }
                
                var isDuplicate = fileNameArray.some(function(item, idx){ 
                    return fileNameArray.indexOf(item) != idx 
                });
                
                // Not valid if duplicate file names
                return !isDuplicate;
            }},
            removeSlots: {value:false},
            profile: {value:null}
        },
        inputs:1,
        outputs:1,
        icon: "fluid.png",
        label: function() { 
            return this.name || "Voice2Json config";
        },
        oneditprepare: function() {
            var node = this;
            if (!node.sentences) {
                //initial text before file was loaded
                node.ogSentences = "// Click the load sentences button.\n"+
                                 "// This will load the content of the sentences.ini\n"+
                                 "// Changes will only be saved to the file\n"+
                                 "// if you deploy after editing.\n"+
                                 "// Enter sentences (= voice commands) Node-RED should recognize.\n" +
                                 "// The sentences have to be written in a dedicated templating language.\n" +
                                 "// See the language syntax on http://voice2json.org/sentences.html";
            } else {
                node.ogSentences = node.sentences;
            }
            
            if (!node.profile) {
                //initial text before file was loaded
                node.ogProfile = "// Click the load profile button.\n"+
                                 "// This will load the content of the profile.yml\n"+
                                 "// Changes will only be saved to the file\n"+
                                 "// if you deploy after editing.\n"+
                                 "// Enter settings as per the voice2json documentation.\n" +
                                 "// You can find this documetation with available settings\n" +
                                 "// at voice2json.org.";
            } else {
                node.ogProfile = node.profile;
            }
            
            node.aceEditorSentences = RED.editor.createEditor({
                id: 'aceDivSentences',
                mode: 'ace/mode/text',
                value: node.ogSentences,
                globals: { 
                    msg:true,
                    context:true,
                    RED: true,
                    util: true,
                    flow: true,
                    global: true,
                    console: true,
                    Buffer: true,
                    setTimeout: true,
                    clearTimeout: true,
                    setInterval: true,
                    clearInterval: true
                }
            });
            node.aceEditorSentences.clearSelection();
            node.aceEditorSentences.focus();
            node.aceEditorSentences.setFontSize(14);
            //setAceEditorReadOnly(node.aceEditorSentences, true);
            
            node.aceEditorSlot = RED.editor.createEditor({
                id: 'aceDivSlot',
                mode: 'ace/mode/text',
                value: "",
                globals: { 
                    msg:true,
                    context:true,
                    RED: true,
                    util: true,
                    flow: true,
                    global: true,
                    console: true,
                    Buffer: true,
                    setTimeout: true,
                    clearTimeout: true,
                    setInterval: true,
                    clearInterval: true
                }
            });
            
            node.aceEditorSlot.setFontSize(14);
            // By default no slot is being visualized in the ace editor
            setAceEditorReadOnly(node.aceEditorSlot, true);
            
            //profile ace
            node.aceEditorProfile = RED.editor.createEditor({
                id: 'aceDivProfile',
                mode: 'ace/mode/yaml',
                value: node.ogProfile,
                globals: { 
                    msg:true,
                    context:true,
                    RED: true,
                    util: true,
                    flow: true,
                    global: true,
                    console: true,
                    Buffer: true,
                    setTimeout: true,
                    clearTimeout: true,
                    setInterval: true,
                    clearInterval: true
                }
            });
            node.aceEditorProfile.clearSelection();
            node.aceEditorProfile.focus();
            node.aceEditorProfile.setFontSize(14);
            
            // Create a table of slots
            var slotsList = $("#node-input-slots-container").css('height','200px').css('min-height','200px').css('min-width','450px').editableList({
                header: $("<div>").append($.parseHTML(
                   "<div style='width:5%; margin-left:5px; display: inline-grid'></div>" +
                   "<div style='width:35%; margin-left:5px; display: inline-grid'><b>Slot Name</b></div>" +
                   "<div style='width:28%; margin-left:5px; display: inline-grid'><b>Managed from</b></div>" +
                   "<div style='width:10%; margin-left:5px; display: inline-grid'><b>Exec</b></div>" +
                   "<div style='width:10%; margin-left:5px; display: inline-grid'><b>Edit/View</b></div>" +
                   "<div style='width:8%; margin-left:5px; display: inline-grid'></div>")),
                addItem: function(container, i, slot) {
                    // When slot === {} then we have a new list item (i.e. user pressed the addItem button)
                    if (Object.keys(slot).length === 0) {
                        // Initialize new items in the list.
                        slot = {
                            fileName    : "", 
                            managedBy   : "nodered",
                            fileContent : ""
                        };
                    }
                    
                    // Add a new row to the editableList
                    var row = $('<div/>').appendTo(container);

                    // Column 1 : Add an input field (type string) to the new row, that indicates whether this row slot is selected for display in the ace editor.
                    // Use visibility 'hidden' (instead of hide()) to make sure the element remains occupating its allocated space.
                    var selectedField = $('<i class="fa fa-check node-input-slot-selected"></i>').css({"visibility":"hidden","resize":"none","vertical-align":"baseline","width":"5%","margin-left":"5px","margin-right":"5px","font-size":"large"}).appendTo(row);
                    
                    // Pass a reference (to the selectedField) to be used in the removeItem function.
                    // See https://discourse.nodered.org/t/how-to-handle-removeitem-in-an-editablelist/27542/2
                    slot.selectedField = selectedField;
                    
                    // Column 2 : Add an input field (type string) to the new row, that represents the file name
                    var fileNameField = $('<input/>',{class:"node-input-slot-fileName",type:"text",placeholder:"File name"}).css({"resize":"none","vertical-align":"top","width":"35%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    fileNameField.prop('required',true);
                    fileNameField.val(slot.fileName);
                    fileNameField.on("change keyup paste", function() {
                        // When the content of this slot is currently being visualized, then immediately update the name above the ace editor
                        if (selectedField.css('visibility') === 'visible') {
                            $("#node-selected-file-label").html('Content of slot file <i><b>"' + fileNameField.val() + '"</b></i>:' );
                        }
                        
                        var fileName = this.value;
                        
                        // Find all fileName input fields with the same file name value
                        var fileNameFields = slotsList.find(".node-input-slot-fileName").filter(function() {
                            return this.value === fileName;
                        })
                        
                        // Show a red border around the fileName field, when the same file name value is used in multiple input fields               
                        if (fileNameFields.length > 1) {
                            $(this).css('border', '1px solid rgb(214, 97, 95)');
                        }
                        else {
                            $(this).css('border', '');
                        }
                    });
                    
                    // Column 3 : Add a dropdown field (type string) to the new row, that represents how the file is managed (by Node-RED or not)
                    var managedByField = $('<select/>', {class: "node-input-slot-managedBy", style: "width:28%; margin-right:10px;", type: "text"}).appendTo(row);
                    managedByField.append($('<option>', {value: "nodered", text: 'this config screen'}));
                    managedByField.append($('<option>', {value: "external", text: 'other source'}));
                    managedByField.val(slot.managedBy);
                    managedByField.on("change", function() {
                        // When the content of this slot is currently being visualized, then immediately set it readonly or not
                        if (selectedField.css('visibility') === 'visible') {
                            switch (managedByField.val()) {
                                case "nodered":
                                    setAceEditorReadOnly(node.aceEditorSlot, false);
                                    break;
                                case "external":
                                    setAceEditorReadOnly(node.aceEditorSlot, true);
                                    break;
                            }
                        }
                    });
                    
                    // Column 4 : Add a checkbox field to the new row, to show whether the file is executable or not, disable enable dependent on managed
                    var executableField = $('<input/>',{class:"node-input-slot-executable",type:"checkbox"}).css({"resize":"none","vertical-align":"baseline","width":"10%","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    executableField.prop('checked', slot.executable);
                    (managedByField.val() === 'nodered') ? executableField.attr("disabled", false) : executableField.attr("disabled", true);
                    managedByField.on("change", function() {
                        (managedByField.val() === 'nodered') ? executableField.attr("disabled", false) : executableField.attr("disabled", true);
                    });
                    // Column 5 : Add a hidden (multiline) textarea field (type string) to the new row, to store the file content
                    var fileContentField = $('<textarea/>',{class:"node-input-slot-fileContent",type:"text"}).appendTo(row);
                    fileContentField.hide();
                    fileContentField.val(slot.fileContent);
                    
                    // Column 6 : Add a button field.
                    var buttonField = $('<button><i></i></button>').css({"resize":"none","vertical-align":"top","width":"8%","height":"34px","margin-left":"5px","margin-right":"5px"}).appendTo(row);
                    // change icon dependent on if read only
                    (managedByField.val() === 'nodered') ? buttonField.find('i').addClass("fa fa-pencil-square-o") : buttonField.find('i').addClass("fa fa-eye");
                    managedByField.on("change", function() {
                        (managedByField.val() === 'nodered') ? buttonField.find('i').removeClass("fa fa-eye").addClass("fa fa-pencil-square-o") : buttonField.find('i').removeClass("fa fa-pencil-square-o").addClass("fa fa-eye");
                    });
                    buttonField.on("click", function(){
                        var selectedSlotRow = getSelectedSlotRow();
                                
                        // If another slot was being displayed before...
                        if (selectedSlotRow) {
                            // Store the content of the ace editor into that slot
                            selectedSlotRow.find(".node-input-slot-fileContent").val(node.aceEditorSlot.getValue());
                            
                            // Remove the selected icon in front of that row
                            selectedSlotRow.find(".node-input-slot-selected").css("visibility", "hidden");
                        }
                        
                        // The ACE editor should be readonly when the slot is not managed by Node-RED
                        switch (managedByField.val()) {
                            case "nodered":
                                setAceEditorReadOnly(node.aceEditorSlot, false);
                                break;
                            case "external":
                                setAceEditorReadOnly(node.aceEditorSlot, true);
 
                                
                                break;
                        }
                        
                        // Show a selection icon in front of this row
                        selectedField.css("visibility", "visible");
                        
                        // Show the file name of this row in the selection label (above the ace editor)
                        $("#node-selected-file-label").html('Content of slot file <i><b>"' + fileNameField.val() + '"</b></i>:' );
                        
                        let loadProfilePath = $("#node-config-input-profilePath").val();
                        // Show the slot content in the ACE editor
                        switch (managedByField.val()) {
                            case "nodered":
                                if (fileContentField.val().length === 0) {
                                    $.ajax({
                                        url: "voice2json-config/loadSlot",
                                        type: "GET",
                                        contentType: "application/json",
                                        data: {
                                            profilePath:loadProfilePath, 
                                            fileName:fileNameField.val(),
                                            executable:executableField.is(':checked')
                                        },
                                        dataType : "text",
                                        success: function(data, textStatus, request) {
                                            node.aceEditorSlot.setValue(data);
                                            node.aceEditorSlot.clearSelection();                                    
                                        },
                                        error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                             node.aceEditorSlot.setValue(fileContentField.val());
                                             node.aceEditorSlot.clearSelection();
                                        } 
                                    });
                                } else {
                                    node.aceEditorSlot.setValue(fileContentField.val());
                                    node.aceEditorSlot.clearSelection();
                                }
                                break;
                                
                            case "external":
                            	//get the content of sentences ini over http endpoint 1st draft
                                $.ajax({
                                    url: "voice2json-config/loadSlot",
                                    type: "GET",
                                    contentType: "application/json",
                                    data: {
                                        profilePath:loadProfilePath, 
                                        fileName:fileNameField.val(),
                                        executable:executableField.is(':checked')
                                    },
                                    dataType : "text",
                                    success: function(data, textStatus, request) {
                                        node.aceEditorSlot.setValue(data);
                                        node.aceEditorSlot.clearSelection();                                    
                                    },
                                    error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                        alert("Cannot load the specified slot file: " + errorThrown); 
                                    } 
                                })
                                break;
                        }
                    })
                },
                removable: true,
                removeItem: function(slot) {
                    // Make sure the removed slot file's content wasn't being displayed at the moment,
                    if (slot.selectedField.css('visibility') === 'visible') {
                        $("#node-selected-file-label").html('No slot selected' );
                        node.aceEditorSlot.setValue("");
                        setAceEditorReadOnly(node.aceEditorSlot, true);
                    }
                }
            });
            
            // Show all the slots (stored in this node) into the editableList
            if (this.slots) {
                this.slots.forEach(function (slot, index) {
                    slotsList.editableList('addItem', {fileName:slot.fileName, managedBy:slot.managedBy, fileContent:slot.fileContent, executable: slot.executable});
                });
            }

            // Support a button to expand the sentences ace editor element
            var expandAceDivSentencesButton = $('#node-expand-aceDivSentences');
            var aceDivSentences = $("#aceDivSentences");
            var aceDivSentencesFullScreenRequest = aceDivSentences[0].requestFullscreen       || 
                                                   aceDivSentences[0].mozRequestFullScreen    || 
                                                   aceDivSentences[0].webkitRequestFullscreen || 
                                                   aceDivSentences[0].msRequestFullScreen;
            // Check whether the browser supports fullscreen
            if (aceDivSentencesFullScreenRequest) {
                expandAceDivSentencesButton[0].title = "Expand fullscreen";
                expandAceDivSentencesButton.click(function(e) {
                    e.preventDefault();
        
                    // Make sure (on all browsers) that the aceDivSentences DIV element has 100% AFTER it has become fullscreen
                    // If document.fullscreenElement is null then full-screen mode has been quitted...
                    aceDivSentences.on('webkitfullscreenchange mozfullscreenchange msRequestFullscreen fullscreenchange', function(e) {
                        if (document.fullscreenElement) {
                            // Make sure the blockly area fills the entire screen
                            document.fullscreenElement.style.height = "100%";
                        }
                        else {
                            // Resize the blockly area to its original size
                            aceDivSentences[0].style.height = "450px";
                            //resize(node);
                        }
                    });
                    
                    // Expand the aceDivSentences element to fullscreen
                    aceDivSentencesFullScreenRequest.call(aceDivSentences[0]);
                })
            }
            else {
                expandAceDivSentencesButton.title = "Fullscreen not supported";
                expandAceDivSentencesButton.prop('disabled', true);
            }
            
            // Support a button to expand the slot ace editor element
            var expandAceDivSlotButton = $('#node-expand-aceDivSlot');
            var aceDivSlot = $("#aceDivSlot");
            var aceDivSlotFullScreenRequest = aceDivSlot[0].requestFullscreen       || 
                                              aceDivSlot[0].mozRequestFullScreen    || 
                                              aceDivSlot[0].webkitRequestFullscreen || 
                                              aceDivSlot[0].msRequestFullScreen;
            // Check whether the browser supports fullscreen
            if (aceDivSlotFullScreenRequest) {
                expandAceDivSlotButton[0].title = "Expand fullscreen";
                expandAceDivSlotButton.click(function(e) {
                    e.preventDefault();
        
                    // Make sure (on all browsers) that the aceDivSlot DIV element has 100% AFTER it has become fullscreen
                    // If document.fullscreenElement is null then full-screen mode has been quitted...
                    aceDivSlot.on('webkitfullscreenchange mozfullscreenchange msRequestFullscreen fullscreenchange', function(e) {
                        if (document.fullscreenElement) {
                            // Make sure the blockly area fills the entire screen
                            document.fullscreenElement.style.height = "100%";
                        }
                        else {
                            // Resize the blockly area to its original size
                            aceDivSlot[0].style.height = "200px";
                            //resize(node);
                        }
                    });
                    
                    // Expand the aceDivSlot element to fullscreen
                    aceDivSlotFullScreenRequest.call(aceDivSlot[0]);
                })
            }
            else {
                expandAceDivSlotButton.title = "Fullscreen not supported";
                expandAceDivSlotButton.prop('disabled', true);
            }
            
            $("#node-load-sentences").click(function () {
                var currentSentences = node.aceEditorSentences.getValue();
                
                if (currentSentences && currentSentences !== "") {
                    if (!confirm("The current sentences will be overwritten!  Are you sure to continue?")) {
                        // The user has clicked the 'Cancel' button
                        return;
                    }
                }
                
	            //get the content of sentences ini over http endpoint
	            let loadProfilePath = $("#node-config-input-profilePath").val();
	            $.ajax({
                    url: "voice2json-config/loadSentences",
                    type: "GET",
                    contentType: "application/json",
                    data: {
                        profilePath:loadProfilePath
                    },
                    dataType : "text",
                    success: function(data, textStatus, request) {
                        node.aceEditorSentences.setValue(data);
                        node.aceEditorSentences.clearSelection();
                        setAceEditorReadOnly(node.aceEditorSentences, false);
                        node.originalSentences = data;                                    
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) { 
                        alert("Cannot load the sentences.ini file: " + errorThrown); 
                    } 
                })
	        });
            
            $("#node-config-input-removeSlots").click(function(){
                if($("#node-config-input-removeSlots").prop("checked")){
                    if (!confirm("If you activate this option slot files that have been added from outside nodered will be deleted.\nYou can use the sync button to get the most recent state of the profile on the file system.\nPlease consider deploying before a sync to save any changes you made from node-red.")) {
                        $("#node-config-input-removeSlots").prop("checked", false) //uncheck if cancel
                        return;
                    }
                }
            });
            
            $("#node-load-slots").click(function () {
                if (!confirm("The slot files will be loaded from the filesystem!  Are you sure to continue?")) {
                    // The user has clicked the 'Cancel' button
                    return;
                }
                
	            //get the slot files over http endpoint
	            let loadProfilePath = $("#node-config-input-profilePath").val();
	            $.ajax({
                    url: "voice2json-config/loadSlotNames",
                    type: "GET",
                    contentType: "application/json",
                    data: {
                        profilePath:loadProfilePath
                    },
                    dataType : "text",
                    success: function(data, textStatus, request) {
                        var jsonData = JSON.parse(data);
                        
                        // Get the slot file names that are currently being displayed in the editableList
                        //var clientNameFields = slotsList.find(".node-input-slot-fileName").toArray();
                        
                        jsonData.slotNames.forEach(function (slotName, index) {
                            var occurences = 0;
                            
                            slotsList.find('.node-input-slot-fileName').each(function(i, fileNameField) {
                                if (fileNameField.value === slotName) {
                                    occurences++;
                                }
                            });
                            
                            if (occurences === 0) {
                                // TODO slot file downloaden via andere http endpoint, en content als 3de parameter doorgeven
                                slotsList.editableList('addItem', {fileName:slotName, managedBy:"external", executable:false});
                            }
                        });
                        
                        jsonData.slotProgramNames.forEach(function (slotProgramName, index) {
                            var occurences = 0;
                            slotsList.find('.node-input-slot-fileName').each(function(i, fileNameField) {
                                 if (fileNameField.value === slotProgramName) {
                                    occurences++;
                                }
                            });
                            
                            if (occurences === 0) {
                                // TODO slot file downloaden via andere http endpoint, en content als 3de parameter doorgeven
                                slotsList.editableList('addItem', {fileName:slotProgramName, managedBy:"external", executable:true});
                            }
                        });
                        
                        /*
                        clientNameFields.forEach(function (clientSlotFileName, index) {
                        // tODO enkel doen als de client slot file type "external is"
                            if (serverSlotFileNames.indexOf(clientSlotFileName) < 0) {
                                slotsList.editableList('removeItem', {fileName:clientSlotFileName});
                            }
                        });*/

                        /*node.aceEditorSentences.setValue(data);
                        node.aceEditorSentences.clearSelection();
                        setAceEditorReadOnly(node.aceEditorSentences, false);
                        node.originalSentences = data;   */                                 
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) { 
                        alert("Cannot load the sentences.ini file: " + errorThrown); 
                    } 
                })
	        });
            
            $("#node-load-profile").click(function () {
                var currentProfile = node.aceEditorProfile.getValue();
                
                if (currentProfile && currentProfile !== "") {
                    if (!confirm("The current profile.yml will be overwritten!  Are you sure to continue?")) {
                        // The user has clicked the 'Cancel' button
                        return;
                    }
                }
                
	            //get content of profile
                let loadProfilePath = $("#node-config-input-profilePath").val();
	            $.ajax({
                    url: "voice2json-config/loadProfile",
                    type: "GET",
                    contentType: "application/json",
                    data: {
                        profilePath:loadProfilePath
                    },
                    dataType : "text",
                    success: function(data, textStatus, request) {
                        node.aceEditorProfile.setValue(data);
                        node.aceEditorProfile.clearSelection();
                        setAceEditorReadOnly(node.aceEditorProfile, false);
                        node.originalProfile = data;                                    
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) { 
                        alert("Cannot load the profile.yml file: " + errorThrown); 
                    } 
                })
	        });
            
            // Show three tabsheets
            var tabs = RED.tabs.create({
                id: "node-tabsheet-tabs",
                onchange: function(tab) {
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-tabsheet-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "node-sentences-tab",
                label: "Sentences"
            });
            tabs.addTab({
                id: "node-slots-tab",
                label: "Slots"
            });
            tabs.addTab({
                id: "node-profile-tab",
                label: "Profile"
            });
        },
        oneditsave: function() {
            var node = this;
            let loadProfilePath = $("#node-config-input-profilePath").val();
            
            //get the content of ace and check if the sentences.ini was loaded and changed
            if (node.ogSentences !== node.aceEditorSentences.getValue()) {
                node.sentences = node.aceEditorSentences.getValue();
            }
		    
            node.aceEditorSentences.destroy();
            node.aceEditorSentences = null;
            
            //get the content of ace and check if the profile.yml was loaded and changed
            if (node.ogProfile !== node.aceEditorProfile.getValue()) {
                node.profile = node.aceEditorProfile.getValue();
            }
		    
            node.aceEditorProfile.destroy();
            node.aceEditorProfile = null;
            
            
            // If some slot was being displayed, lets store the content of the ace editor into that slot
            var selectedSlotRow = getSelectedSlotRow();
            if (selectedSlotRow) {
                selectedSlotRow.find(".node-input-slot-fileContent").val(node.aceEditorSlot.getValue());
            }
                        
            node.aceEditorSlot.destroy();
            node.aceEditorSlot = null;
            
            // Copy all the slots from the editableList to this node
            node.slots = [];
            var slotsList = $("#node-input-slots-container").editableList('items');
            slotsList.each(function(i) {
                var slot = $(this);
                var fileName    = slot.find(".node-input-slot-fileName").val();
                var managedBy   = slot.find(".node-input-slot-managedBy").val();
                var executable  = slot.find(".node-input-slot-executable").is(':checked');
                var fileContent = null;
                
                // Only store the file content in this node, when this is being managed by Node-RED
                if (managedBy === "nodered") {
                    fileContent = slot.find(".node-input-slot-fileContent").val();
                    if (fileContent.length === 0) {
                        console.log('this one is empty: ' + fileContent);
                        $.ajax({
                            url: "voice2json-config/loadSlot",
                            type: "GET",
                            contentType: "application/json",
                            data: {
                                profilePath:loadProfilePath, 
                                fileName:fileName,
                                executable:executable
                            },
                            dataType : "text",
                            async: false,
                            success: function(data, textStatus, request) {
                                fileContent = data;
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                fileContent = "";
                            } 
                        });
                    }
                }
                node.slots.push({fileName:fileName, managedBy:managedBy, fileContent:fileContent, executable:executable});
            });
        },
        oneditcancel: function() {
            var node = this;
            node.aceEditorSentences.destroy();
            node.aceEditorSentences = null;
            node.aceEditorProfile.destroy();
            node.aceEditorProfile = null;
        }
    });
</script>

<script type="text/x-red" data-template-name="voice2json-config">
    <div class="form-row">
        <label for="node-config-input-profilePath"><i class="fa fa-file"></i> Profile</label>
        <input type="text" id="node-config-input-profilePath">
    </div>
    <br>
    <div id="filesDiv">
        <div class="form-row">
            <!-- Two tabsheets -->
            <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-tabsheet-tabs"></ul>
        </div>
        <div id="node-tabsheet-content" style="min-height: 350px">
            <div id="node-sentences-tab">
                <button id="node-expand-aceDivSentences" class="editor-button editor-button-small" style="margin-top: 4px;" title="Show fullscreen">
                    <i class="fa fa-expand"></i>
                </button>
                <button id="node-load-sentences" class="editor-button editor-button-small" style="margin-top: 4px;" title="Load sentences.ini file">
                    <i class="fa fa-download"></i>
                </button>
                <div class="form-row">
                    <!-- Ace editor -->
                    <div id="aceDivSentences" style="width: 100%; height: 450px; min-height:350px;"></div>
                </div>
            </div>
            <div id="node-slots-tab">
                <button id="node-load-slots" class="editor-button editor-button-small" style="margin-top: 4px;" title="Load slot files">
                    <i class="fa fa-download"></i>
                </button>
                <div class="form-row form-row-auto-height">
                    <!-- Table with slot files -->
                    <ol id="node-input-slots-container"></ol>
                </div>
                <br>
                <label id="node-selected-file-label" style="display:initial; vertical-align:bottom; margin-right:30px;"><i class="fa fa-list"></i> No slot selected</label>
                <button id="node-expand-aceDivSlot" class="editor-button editor-button-small" style="margin-top: 4px;" title="Show fullscreen">
                    <i class="fa fa-expand"></i>
                </button>
                <div class="form-row">
                    <!-- Ace editor -->
                    <div id="aceDivSlot" style="width: 100%; height: 400px; min-height:300px;"></div>
                </div>
                <br>
                <div class="form-row">
                    <input type="checkbox" id="node-config-input-removeSlots" style="display: inline-block; width: auto; vertical-align: top;">
                    <label for="node-config-input-removeSlots" style="width:70%;"> Automatically remove slot files not listed on this screen</label>
                </div>
            </div>
            <div id="node-profile-tab">
                <button id="node-load-profile" class="editor-button editor-button-small" style="margin-top: 4px;" title="Load profile.yml file">
                    <i class="fa fa-download"></i>
                </button>
                <div class="form-row">
                    <!-- Ace editor -->
                    <div id="aceDivProfile" style="width: 100%; height: 450px; min-height:350px;"></div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="voice2json-config">
    <p>A config node for all Voice2Json related nodes.</p>
    <p><strong>Profile:</strong><br/>
    The path to the downloaded profile.</p>
</script>
